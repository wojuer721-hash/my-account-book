<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è®°è´¦æœ¬</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #FF8DC7;
            --secondary: #A3D8FF;
            --accent: #FFD59E;
            --light: #FFF5E4;
            --text: #5A5A5A;
            --success: #A8E6CF;
            --danger: #FFAAA5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --touch-size: 44px;
        }
        
        body {
            background: linear-gradient(135deg, #FFD6E7 0%, #C1E3FF 100%);
            color: var(--text);
            line-height: 1.5;
            padding: 12px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px 15px;
            border-radius: var(--radius);
            background: var(--card-bg);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        h1 i {
            color: var(--accent);
            font-size: 1.6rem;
        }
        
        .summary-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 2px dashed var(--secondary);
            backdrop-filter: blur(10px);
        }
        
        .summary-card h2 {
            font-size: 1rem;
            margin-bottom: 8px;
            opacity: 0.9;
            color: var(--primary);
        }
        
        .summary-card .amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-section, .records-section, .analysis-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .form-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--secondary);
        }
        
        .records-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--accent);
        }
        
        .analysis-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #A8E6CF;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px dotted var(--secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: var(--accent);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
        }
        
        label i {
            color: var(--primary);
            width: 18px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E8E8E8;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
            -webkit-appearance: none;
            appearance: none;
            min-height: var(--touch-size);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 141, 199, 0.2);
        }
        
        .btn {
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: var(--touch-size);
            touch-action: manipulation;
            user-select: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #FF6BAE);
            color: white;
            box-shadow: 0 3px 8px rgba(255, 107, 174, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 1px 4px rgba(255, 107, 174, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #7ED9A3);
            color: white;
            box-shadow: 0 3px 8px rgba(168, 230, 207, 0.3);
        }
        
        .btn-success:active {
            transform: translateY(2px);
            box-shadow: 0 1px 4px rgba(168, 230, 207, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #FF8A80);
            color: white;
            box-shadow: 0 3px 8px rgba(255, 170, 165, 0.3);
        }
        
        .btn-danger:active {
            transform: translateY(2px);
            box-shadow: 0 1px 4px rgba(255, 170, 165, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #E8E8E8, #D0D0D0);
            color: var(--text);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:active {
            transform: translateY(2px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        
        .buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .buttons .btn {
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 0.9rem;
            min-width: 600px; /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šå¯ä»¥æ°´å¹³æ»šåŠ¨ */
        }
        
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #F0F0F0;
        }
        
        th {
            background-color: rgba(163, 216, 255, 0.2);
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        tr:hover {
            background-color: rgba(255, 213, 158, 0.1);
        }
        
        .income {
            color: #2E8B57;
            font-weight: 500;
        }
        
        .expense {
            color: #FF6B6B;
            font-weight: 500;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .actions .btn {
            padding: 8px 10px;
            font-size: 0.85rem;
            border-radius: 8px;
            min-height: 36px;
        }
        
        .project-management {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dotted var(--secondary);
        }
        
        .project-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .project-item {
            background: white;
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #F0F0F0;
            flex: 1 0 calc(50% - 8px);
            max-width: calc(50% - 8px);
        }
        
        .project-item.income {
            border-left: 4px solid var(--success);
        }
        
        .project-item.expense {
            border-left: 4px solid var(--danger);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            padding: 15px;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            position: relative;
            border: 2px solid var(--primary);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            transition: all 0.3s;
            padding: 5px;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:active {
            color: var(--primary);
            transform: scale(0.95);
        }
        
        .search-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 2px dashed var(--accent);
        }
        
        .search-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .search-group {
            width: 100%;
        }
        
        .search-results-info {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text);
            padding: 10px;
            background: rgba(255, 213, 158, 0.2);
            border-radius: 10px;
            text-align: center;
        }
        
        .record-count {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin: 0 3px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                max-width: 1200px;
            }
            
            .content {
                flex-direction: row;
            }
            
            .form-section, .records-section, .analysis-section {
                flex: 1;
                min-width: 300px;
            }
            
            .buttons {
                flex-direction: row;
            }
            
            .buttons .btn {
                width: auto;
            }
            
            .search-row {
                flex-direction: row;
            }
            
            .search-group {
                flex: 1;
                min-width: 200px;
            }
            
            .project-item {
                flex: 1 0 calc(33.333% - 8px);
                max-width: calc(33.333% - 8px);
            }
            
            table {
                min-width: auto;
                font-size: 1rem;
            }
        }
        
        .floating-elements {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.4rem;
            color: white;
            touch-action: manipulation;
        }
        
        .floating-btn.primary {
            background: var(--primary);
        }
        
        .floating-btn.success {
            background: var(--success);
        }
        
        .floating-btn:active {
            transform: scale(0.95);
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--text);
        }
        
        .empty-state i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 16px;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .type-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .type-income {
            background: var(--success);
        }
        
        .type-expense {
            background: var(--danger);
        }
        
        .emoji {
            font-size: 1.1rem;
            margin-right: 4px;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .pagination-info {
            font-size: 0.85rem;
            color: var(--text);
            text-align: center;
        }
        
        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .pagination-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            background: var(--secondary);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-height: 40px;
            min-width: 40px;
            touch-action: manipulation;
        }
        
        .pagination-btn:active:not(:disabled) {
            background: var(--primary);
            color: white;
            transform: translateY(2px);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .page-size-selector select {
            width: auto;
            padding: 8px 12px;
            min-height: 40px;
        }
        
        /* å¤šé€‰ä¸‹æ‹‰æ¡†æ ·å¼ */
        .multiselect-container {
            position: relative;
        }
        
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 2px solid #E8E8E8;
            border-radius: 12px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .multiselect-dropdown.active {
            display: block;
        }
        
        .multiselect-search {
            padding: 10px;
            border-bottom: 1px solid #E8E8E8;
        }
        
        .multiselect-search input {
            padding: 10px 12px;
            border-radius: 8px;
            min-height: 40px;
        }
        
        .multiselect-options {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .multiselect-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            min-height: 44px;
        }
        
        .multiselect-option:active {
            background: rgba(163, 216, 255, 0.2);
        }
        
        .multiselect-option.selected {
            background: rgba(255, 141, 199, 0.2);
        }
        
        .multiselect-selected {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .selected-tag {
            background: var(--primary);
            color: white;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            max-width: 100%;
        }
        
        .selected-tag .remove {
            cursor: pointer;
            font-weight: bold;
            padding: 2px;
        }
        
        .multiselect-input {
            cursor: pointer;
            position: relative;
            padding: 14px 16px;
            border: 2px solid #E8E8E8;
            border-radius: 12px;
            background: white;
            min-height: var(--touch-size);
            display: flex;
            align-items: center;
        }
        
        .multiselect-input::after {
            content: "â–¼";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text);
            pointer-events: none;
        }
        
        /* å¯¼å…¥åŠŸèƒ½æ ·å¼ */
        .import-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dotted var(--secondary);
        }
        
        .import-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        @media (min-width: 480px) {
            .import-actions {
                flex-direction: row;
            }
        }
        
        .import-preview {
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #E8E8E8;
            border-radius: 12px;
            padding: 12px;
            background: white;
        }
        
        .import-preview table {
            margin-top: 0;
            font-size: 0.85rem;
        }
        
        .import-preview th, .import-preview td {
            padding: 8px 10px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 14px 16px;
            border: 2px dashed var(--secondary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(163, 216, 255, 0.1);
            min-height: var(--touch-size);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .file-input-label:active {
            background: rgba(163, 216, 255, 0.2);
            border-color: var(--primary);
        }
        
        .file-input-label i {
            color: var(--primary);
        }
        
        /* è¡¨æ ¼å®¹å™¨ï¼Œç”¨äºåœ¨æ‰‹æœºä¸Šå®ç°æ°´å¹³æ»šåŠ¨ */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -20px;
            padding: 0 20px;
            width: calc(100% + 40px);
        }
        
        /* ç§»åŠ¨ç«¯èœå•åˆ‡æ¢ */
        .mobile-tabs {
            display: none;
        }
        
        @media (max-width: 767px) {
            .mobile-tabs {
                display: flex;
                background: var(--card-bg);
                border-radius: var(--radius);
                margin-bottom: 16px;
                overflow: hidden;
                box-shadow: var(--shadow);
            }
            
            .mobile-tab {
                flex: 1;
                padding: 14px 10px;
                text-align: center;
                font-weight: 500;
                color: var(--text);
                cursor: pointer;
                transition: all 0.3s;
                border-bottom: 3px solid transparent;
                position: relative;
                -webkit-tap-highlight-color: transparent;
                user-select: none;
            }
            
            .mobile-tab.active {
                color: var(--primary);
                border-bottom-color: var(--primary);
                background: rgba(255, 141, 199, 0.1);
            }
            
            .mobile-tab.active::after {
                content: '';
                position: absolute;
                bottom: -3px;
                left: 50%;
                transform: translateX(-50%);
                width: 0;
                height: 0;
                border-left: 8px solid transparent;
                border-right: 8px solid transparent;
                border-top: 8px solid var(--primary);
            }
            
            .mobile-tab.touching {
                background: rgba(255, 141, 199, 0.15) !important;
                transition: none !important;
            }
            
            .mobile-tab.clicked {
                background: rgba(255, 141, 199, 0.2) !important;
                transform: scale(0.98);
            }
            
            .form-section, .records-section, .analysis-section {
                display: none;
            }
            
            .form-section.active, .records-section.active, .analysis-section.active {
                display: block;
            }
            
            /* è°ƒæ•´å®¹å™¨åº•éƒ¨paddingï¼Œé¿å…å†…å®¹è¢«åº•éƒ¨æ é®æŒ¡ */
            .container {
                padding-bottom: 20px; /* å‡å°‘åº•éƒ¨padding */
            }
            
            /* éšè—æ¡Œé¢ç‰ˆæµ®åŠ¨æŒ‰é’® */
            .floating-elements {
                display: none;
            }
        }
        
        /* è¾“å…¥æ¡†å ä½ç¬¦æ ·å¼ */
        ::placeholder {
            color: #aaa;
            opacity: 1;
        }
        
        /* è‡ªå®šä¹‰é€‰æ‹©æ¡†ç®­å¤´ */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235A5A5A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 40px;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 141, 199, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 141, 199, 0.7);
        }
        
        /* æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        /* å¿«é€Ÿæ“ä½œèœå• */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 10px;
            background: white;
            border: 1px solid #E8E8E8;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .quick-action-btn:active {
            background: rgba(255, 141, 199, 0.1);
            border-color: var(--primary);
            transform: translateY(2px);
        }
        
        .quick-action-btn i {
            font-size: 1.4rem;
            color: var(--primary);
        }
        
        .quick-action-btn span {
            font-size: 0.9rem;
            color: var(--text);
        }
        
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid #F0F0F0;
            position: relative;
        }
        
        .chart-title {
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .chart-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-control-group label {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .chart-control-group select {
            padding: 8px 12px;
            min-height: 36px;
            width: auto;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .no-data-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }
        
        .chart-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px;
            background: rgba(163, 216, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .chart-summary-item {
            text-align: center;
            flex: 1;
        }
        
        .chart-summary-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 992px) {
            .analysis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ç§»åŠ¨ç«¯æ—¥æœŸé€‰æ‹©å™¨ä¼˜åŒ– */
        @media (max-width: 767px) {
            input[type="date"] {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
            }
            
            .chart-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chart-control-group {
                width: 100%;
            }
            
            .chart-control-group select {
                width: 100%;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-piggy-bank"></i> è®°è´¦æœ¬</h1>
            <p>è½»æ¾è®°å½•æ¯ä¸€ç¬”æ”¶æ”¯ï¼Œè®©è´¢åŠ¡ç®¡ç†å˜å¾—ç®€å•åˆæœ‰è¶£</p>
        </header>
        
        <div class="summary-card">
            <h2><i class="fas fa-wallet"></i> å½“å‰ä½™é¢</h2>
            <div class="amount" id="totalAmount">Â¥0.00</div>
        </div>
        
        <div class="mobile-tabs">
            <div class="mobile-tab active" data-tab="form"><i class="fas fa-plus-circle"></i> è®°è´¦</div>
            <div class="mobile-tab" data-tab="records"><i class="fas fa-list-alt"></i> è®°å½•</div>
            <div class="mobile-tab" data-tab="analysis"><i class="fas fa-chart-line"></i> åˆ†æ</div>
            <div class="mobile-tab" data-tab="projects"><i class="fas fa-tags"></i> é¡¹ç›®</div>
        </div>
        
        <div class="content">
            <div class="form-section active" id="formTab">
                <h2 class="section-title"><i class="fas fa-plus-circle"></i> æ·»åŠ æ–°è®°å½•</h2>
                <form id="accountForm">
                    <div class="form-group">
                        <label for="date"><i class="fas fa-calendar-alt"></i> æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="type"><i class="fas fa-exchange-alt"></i> ç±»å‹</label>
                        <select id="type" required>
                            <option value="expense">æ”¯å‡º ğŸ’¸</option>
                            <option value="income">æ”¶å…¥ ğŸ’°</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="project"><i class="fas fa-tags"></i> é¡¹ç›®</label>
                        <select id="project" required>
                            </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount"><i class="fas fa-coins"></i> é‡‘é¢</label>
                        <input type="number" id="amount" step="0.01" min="0" placeholder="è¯·è¾“å…¥é‡‘é¢" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="note"><i class="fas fa-sticky-note"></i> å¤‡æ³¨</label>
                        <textarea id="note" rows="3" placeholder="æ·»åŠ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                    
                    <div class="buttons">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> æ·»åŠ è®°å½•</button>
                        <button type="button" class="btn btn-secondary" id="resetBtn"><i class="fas fa-redo"></i> é‡ç½®</button>
                    </div>
                </form>
                
                <div class="quick-actions">
                    <div class="quick-action-btn" id="quickIncomeBtn">
                        <i class="fas fa-money-bill-wave"></i> <span>å¿«é€Ÿæ”¶å…¥</span>
                    </div>
                    <div class="quick-action-btn" id="quickExpenseBtn">
                        <i class="fas fa-shopping-cart"></i> <span>å¿«é€Ÿæ”¯å‡º</span>
                    </div>
                    <div class="quick-action-btn" id="quickFoodBtn">
                        <i class="fas fa-utensils"></i> <span>é¤é¥®æ¶ˆè´¹</span>
                    </div>
                </div>

                <div class="import-section">
                    <h3 class="section-title"><i class="fas fa-file-import"></i> å¯¼å…¥è®°å½•</h3>
                    <div class="file-input-wrapper">
                        <input type="file" id="importFile" accept=".xlsx, .xls, .csv">
                        <label for="importFile" class="file-input-label" id="importFileLabel">
                            <i class="fas fa-upload"></i> é€‰æ‹©Excel/CSVæ–‡ä»¶å¯¼å…¥
                        </label>
                    </div>
                    <div class="import-preview" style="display: none;">
                        <h4>å¯¼å…¥é¢„è§ˆ (å‰5æ¡è®°å½•):</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>ç±»å‹</th>
                                    <th>é¡¹ç›®</th>
                                    <th>é‡‘é¢</th>
                                    <th>å¤‡æ³¨</th>
                                </tr>
                            </thead>
                            <tbody id="importPreviewBody">
                                </tbody>
                        </table>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: var(--danger);" id="importWarning"></p>
                    </div>
                    <div class="buttons import-actions">
                        <button type="button" class="btn btn-success" id="importBtn" disabled><i class="fas fa-check"></i> ç¡®è®¤å¯¼å…¥</button>
                        <button type="button" class="btn btn-secondary" id="downloadTemplateBtn"><i class="fas fa-download"></i> ä¸‹è½½æ¨¡æ¿</button>
                    </div>
                </div>

            </div>
            
            <div class="records-section" id="recordsTab">
                <h2 class="section-title"><i class="fas fa-list-alt"></i> è®°å½•åˆ—è¡¨</h2>
                
                <div class="search-section">
                    <h3><i class="fas fa-filter"></i> ç­›é€‰æ¡ä»¶</h3>
                    <div class="search-row">
                        <div class="search-group">
                            <label for="startDate"><i class="fas fa-calendar"></i> å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="search-group">
                            <label for="endDate"><i class="fas fa-calendar"></i> ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>
                    
                    <div class="form-group multiselect-container">
                        <label><i class="fas fa-tags"></i> ç­›é€‰é¡¹ç›®</label>
                        <div class="multiselect-input" id="multiselectInput">é€‰æ‹©é¡¹ç›®...</div>
                        <div class="multiselect-dropdown" id="multiselectDropdown">
                            <div class="multiselect-search">
                                <input type="text" id="multiselectSearch" placeholder="æœç´¢é¡¹ç›®...">
                            </div>
                            <div class="multiselect-options" id="multiselectOptions">
                                </div>
                        </div>
                        <div class="multiselect-selected" id="multiselectSelected">
                            </div>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="btn btn-primary" id="searchBtn"><i class="fas fa-search"></i> æœç´¢/ç­›é€‰</button>
                        <button type="button" class="btn btn-secondary" id="resetSearchBtn"><i class="fas fa-times"></i> é‡ç½®ç­›é€‰</button>
                    </div>
                    <div class="search-results-info" id="searchResultsInfo"></div>
                </div>
                
                <div class="table-container">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ç±»å‹</th>
                                <th>é¡¹ç›®</th>
                                <th>é‡‘é¢</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-box-open"></i>
                    <p>æš‚æ— è®°å½•</p>
                    <p>å¿«å»æ·»åŠ ä½ çš„ç¬¬ä¸€ç¬”æ”¶æ”¯å§ï¼</p>
                </div>
                
                <div class="pagination" id="paginationSection" style="display: none;">
                    <div class="pagination-info" id="paginationInfo"></div>
                    <div class="pagination-controls">
                        <div class="page-size-selector">
                            <span>æ¯é¡µæ˜¾ç¤º:</span>
                            <select id="pageSize">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                        <button class="pagination-btn" id="firstPageBtn" disabled>é¦–é¡µ</button>
                        <button class="pagination-btn" id="prevPageBtn" disabled>ä¸Šä¸€é¡µ</button>
                        <span id="currentPageIndicator">1</span>
                        <button class="pagination-btn" id="nextPageBtn" disabled>ä¸‹ä¸€é¡µ</button>
                        <button class="pagination-btn" id="lastPageBtn" disabled>æœ«é¡µ</button>
                    </div>
                </div>

                <div class="buttons">
                    <button type="button" class="btn btn-success" id="exportBtn"><i class="fas fa-file-export"></i> å¯¼å‡ºè®°å½• (XLSX)</button>
                    <button type="button" class="btn btn-danger" id="clearBtn"><i class="fas fa-eraser"></i> æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
                </div>
            </div>

            <div class="analysis-section" id="analysisTab">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> æ”¶æ”¯åˆ†æ</h2>
                
                <div class="search-section">
                    <h3><i class="fas fa-calendar-alt"></i> åˆ†ææ—¶é—´èŒƒå›´</h3>
                    <div class="search-row">
                        <div class="search-group">
                            <label for="analysisStartDate"><i class="fas fa-calendar"></i> å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="analysisStartDate">
                        </div>
                        <div class="search-group">
                            <label for="analysisEndDate"><i class="fas fa-calendar"></i> ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="analysisEndDate">
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn btn-primary" id="updateAnalysisBtn"><i class="fas fa-sync-alt"></i> æ›´æ–°åˆ†æ</button>
                        <button class="btn btn-secondary" id="resetAnalysisBtn"><i class="fas fa-times"></i> é‡ç½®æ—¶é—´</button>
                    </div>
                </div>

                <div class="analysis-grid">
                    <div class="chart-container">
                        <div class="chart-title"><i class="fas fa-chart-pie"></i> æ”¯å‡ºé¡¹ç›®å æ¯”</div>
                        <div class="chart-controls">
                            <div class="chart-control-group">
                                <label>åˆ†ç»„æ–¹å¼:</label>
                                <select id="expensePieGroupBy">
                                    <option value="project">æŒ‰é¡¹ç›®</option>
                                    <option value="type">æŒ‰ç±»å‹</option>
                                </select>
                            </div>
                            <div class="chart-control-group">
                                <label>åŒ…å«é¡¹ç›®:</label>
                                <select id="expenseProjectFilter">
                                    <option value="all">æ‰€æœ‰æ”¯å‡ºé¡¹ç›®</option>
                                    </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="expensePieChart"></canvas>
                            <div class="no-data-message" id="noExpenseData" style="display: none;">
                                <span><i class="fas fa-chart-area"></i> æš‚æ— æ”¯å‡ºæ•°æ®</span>
                            </div>
                        </div>
                        <div class="chart-summary" id="expenseSummary" style="display: none;">
                            <div class="chart-summary-item">
                                <span>æ€»æ”¯å‡º</span>
                                <div class="chart-summary-value expense" id="totalExpenseAmount">Â¥0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title"><i class="fas fa-chart-line"></i> æ”¶å…¥è¶‹åŠ¿</div>
                        <div class="chart-controls">
                            <div class="chart-control-group">
                                <label>åˆ†ç»„æ–¹å¼:</label>
                                <select id="incomeTrendGroupBy">
                                    <option value="day">æŒ‰æ—¥</option>
                                    <option value="week">æŒ‰å‘¨</option>
                                    <option value="month">æŒ‰æœˆ</option>
                                </select>
                            </div>
                            <div class="chart-control-group">
                                <label>åŒ…å«é¡¹ç›®:</label>
                                <select id="incomeProjectFilter">
                                    <option value="all">æ‰€æœ‰æ”¶å…¥é¡¹ç›®</option>
                                    </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="incomeTrendChart"></canvas>
                            <div class="no-data-message" id="noIncomeData" style="display: none;">
                                <span><i class="fas fa-chart-area"></i> æš‚æ— æ”¶å…¥æ•°æ®</span>
                            </div>
                        </div>
                        <div class="chart-summary" id="incomeSummary" style="display: none;">
                            <div class="chart-summary-item">
                                <span>æ€»æ”¶å…¥</span>
                                <div class="chart-summary-value income" id="totalIncomeAmount">Â¥0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title"><i class="fas fa-chart-line"></i> æ”¯å‡ºè¶‹åŠ¿</div>
                        <div class="chart-controls">
                            <div class="chart-control-group">
                                <label>åˆ†ç»„æ–¹å¼:</label>
                                <select id="expenseTrendGroupBy">
                                    <option value="day">æŒ‰æ—¥</option>
                                    <option value="week">æŒ‰å‘¨</option>
                                    <option value="month">æŒ‰æœˆ</option>
                                </select>
                            </div>
                            <div class="chart-control-group">
                                <label>åŒ…å«é¡¹ç›®:</label>
                                <select id="expenseTrendProjectFilter">
                                    <option value="all">æ‰€æœ‰æ”¯å‡ºé¡¹ç›®</option>
                                    </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="expenseTrendChart"></canvas>
                            <div class="no-data-message" id="noExpenseTrendData" style="display: none;">
                                <span><i class="fas fa-chart-area"></i> æš‚æ— æ”¯å‡ºæ•°æ®</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title"><i class="fas fa-balance-scale"></i> å‡€æ”¶å…¥è¶‹åŠ¿</div>
                        <div class="chart-controls">
                            <div class="chart-control-group">
                                <label>åˆ†ç»„æ–¹å¼:</label>
                                <select id="netTrendGroupBy">
                                    <option value="day">æŒ‰æ—¥</option>
                                    <option value="week">æŒ‰å‘¨</option>
                                    <option value="month">æŒ‰æœˆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="balanceTrendChart"></canvas>
                            <div class="no-data-message" id="noBalanceData" style="display: none;">
                                <span><i class="fas fa-chart-area"></i> æš‚æ— å‡€æ”¶å…¥æ•°æ®</span>
                            </div>
                        </div>
                        <div class="chart-summary" id="netSummary" style="display: none;">
                            <div class="chart-summary-item">
                                <span>å‡€æ”¶å…¥</span>
                                <div class="chart-summary-value" id="netIncomeAmount">Â¥0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section" id="projectsTab">
                <h2 class="section-title"><i class="fas fa-tags"></i> é¡¹ç›®ç®¡ç†</h2>
                <div class="project-management">
                    <button class="btn btn-success" id="addProjectBtn"><i class="fas fa-plus"></i> æ·»åŠ é¡¹ç›®</button>
                    <div class="project-list" id="projectList">
                        </div>
                </div>
                <div class="quick-actions">
                    <div class="quick-action-btn" id="addIncomeProjectBtn">
                        <i class="fas fa-money-bill-wave"></i> <span>æ·»åŠ æ”¶å…¥é¡¹ç›®</span>
                    </div>
                    <div class="quick-action-btn" id="addExpenseProjectBtn">
                        <i class="fas fa-shopping-cart"></i> <span>æ·»åŠ æ”¯å‡ºé¡¹ç›®</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> æ·»åŠ /ç¼–è¾‘é¡¹ç›®</h3>
                <span class="close">&times;</span>
            </div>
            <form id="projectForm">
                <div class="form-group">
                    <label for="projectName"><i class="fas fa-tag"></i> é¡¹ç›®åç§°</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label for="projectType"><i class="fas fa-exchange-alt"></i> é¡¹ç›®ç±»å‹</label>
                    <select id="projectType" required>
                        <option value="expense">æ”¯å‡ºé¡¹ç›® ğŸ’¸</option>
                        <option value="income">æ”¶å…¥é¡¹ç›® ğŸ’°</option>
                    </select>
                </div>
                <div class="buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" id="cancelProjectBtn"><i class="fas fa-times"></i> å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <div class="floating-elements">
        <div class="floating-btn primary" id="quickAddBtn" title="å¿«é€Ÿè®°è´¦">
            <i class="fas fa-plus"></i>
        </div>
        <div class="floating-btn success" id="quickExportBtn" title="å¯¼å‡ºæ•°æ®">
            <i class="fas fa-file-export"></i>
        </div>
    </div>

    <script>
        // åˆå§‹æ•°æ®å’ŒçŠ¶æ€
        let projects = [
            { id: 1, name: "å·¥èµ„", type: "income", emoji: "ğŸ’°" },
            { id: 2, name: "ç†è´¢æ”¶å…¥", type: "income", emoji: "ğŸ“ˆ" },
            { id: 3, name: "å…¶ä»–æ”¶å…¥", type: "income", emoji: "ğŸ" },
            { id: 4, name: "åƒé¥­", type: "expense", emoji: "ğŸ”" },
            { id: 5, name: "äº¤é€š", type: "expense", emoji: "ğŸš—" },
            { id: 6, name: "ä½æˆ¿", type: "expense", emoji: "ğŸ " },
            { id: 7, name: "è´­ç‰©", type: "expense", emoji: "ğŸ›ï¸" },
            { id: 8, name: "å¨±ä¹", type: "expense", emoji: "ğŸ¬" },
            { id: 9, name: "åŒ»ç–—", type: "expense", emoji: "âš•ï¸" },
            { id: 10, name: "å­¦ä¹ ", type: "expense", emoji: "ğŸ“š" },
            { id: 11, name: "æŠ•èµ„æ”¯å‡º", type: "expense", emoji: "ğŸ“‰" },
            { id: 12, name: "æ—¥ç”¨å“", type: "expense", emoji: "ğŸ§´" },
            { id: 13, name: "å® ç‰©", type: "expense", emoji: "ğŸ¶" },
            { id: 14, name: "ç”µå­äº§å“", type: "expense", emoji: "ğŸ“±" },
            { id: 15, name: "æ—…æ¸¸", type: "expense", emoji: "âœˆï¸" },
            { id: 16, name: "äººæƒ…å¾€æ¥", type: "expense", emoji: "ğŸ§§" },
            { id: 17, name: "é€šè®¯", type: "expense", emoji: "ğŸ“" },
            { id: 18, name: "æ°´ç”µç…¤", type: "expense", emoji: "ğŸ’¡" },
            { id: 19, name: "è¿åŠ¨å¥èº«", type: "expense", emoji: "ğŸƒ" },
            { id: 20, name: "æœé¥°", type: "expense", emoji: "ğŸ‘—" },
            { id: 21, name: "ç¤¼ç‰©", type: "expense", emoji: "ğŸ" },
            { id: 22, name: "é¥°å“", type: "expense", emoji: "ğŸ’" },
            { id: 23, name: "è®¾å¤‡", type: "expense", emoji: "ğŸ’»" }
        ];

        let records = [];
        let editingProjectId = null;
        let currentFilter = { startDate: null, endDate: null, projects: [] };

        // åˆ†æç›¸å…³å˜é‡
        let analysisFilter = { startDate: null, endDate: null };
        // å›¾è¡¨å®ä¾‹
        let expensePieChart = null;
        let expenseTrendChart = null;
        let incomeTrendChart = null;
        let balanceTrendChart = null;

        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;

        // å¯¼å…¥ç›¸å…³å˜é‡
        let importData = [];

        // ç§»åŠ¨ç«¯å½“å‰æ ‡ç­¾
        let currentMobileTab = 'form';
        // è§¦æ‘¸ç›¸å…³å˜é‡ - ç”¨äºé˜²æ­¢è¯¯è§¦
        let isMobileTabTouchActive = false;

        // DOM å…ƒç´ 
        const accountForm = document.getElementById('accountForm');
        const projectForm = document.getElementById('projectForm');
        const projectSelect = document.getElementById('project');
        const projectList = document.getElementById('projectList');
        const recordsTable = document.getElementById('recordsTable').getElementsByTagName('tbody')[0];
        const totalAmountElement = document.getElementById('totalAmount');
        const projectModal = document.getElementById('projectModal');
        const addProjectBtn = document.getElementById('addProjectBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resetBtn = document.getElementById('resetBtn');
        const cancelProjectBtn = document.getElementById('cancelProjectBtn');
        const closeModalBtn = document.querySelector('.close');
        const searchBtn = document.getElementById('searchBtn');
        const resetSearchBtn = document.getElementById('resetSearchBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const searchResultsInfo = document.getElementById('searchResultsInfo');
        const quickAddBtn = document.getElementById('quickAddBtn');
        const quickExportBtn = document.getElementById('quickExportBtn');

        // åˆ†é¡µç›¸å…³DOMå…ƒç´ 
        const pageSizeSelect = document.getElementById('pageSize');
        const firstPageBtn = document.getElementById('firstPageBtn');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const lastPageBtn = document.getElementById('lastPageBtn');
        const currentPageIndicator = document.getElementById('currentPageIndicator');
        const paginationInfo = document.getElementById('paginationInfo');

        // å¤šé€‰ä¸‹æ‹‰æ¡†ç›¸å…³DOMå…ƒç´ 
        const multiselectInput = document.getElementById('multiselectInput');
        const multiselectDropdown = document.getElementById('multiselectDropdown');
        const multiselectSearch = document.getElementById('multiselectSearch');
        const multiselectOptions = document.getElementById('multiselectOptions');
        const multiselectSelected = document.getElementById('multiselectSelected');

        // å¯¼å…¥ç›¸å…³DOMå…ƒç´ 
        const importFileInput = document.getElementById('importFile');
        const importBtn = document.getElementById('importBtn');
        const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
        const importPreview = document.querySelector('.import-preview');
        const importPreviewBody = document.getElementById('importPreviewBody');
        const importWarning = document.getElementById('importWarning');
        const importFileLabel = document.getElementById('importFileLabel');

        // åˆ†æå›¾è¡¨ç›¸å…³DOMå…ƒç´ 
        const analysisStartDateInput = document.getElementById('analysisStartDate');
        const analysisEndDateInput = document.getElementById('analysisEndDate');
        const updateAnalysisBtn = document.getElementById('updateAnalysisBtn');
        const resetAnalysisBtn = document.getElementById('resetAnalysisBtn');

        const expensePieCanvas = document.getElementById('expensePieChart').getContext('2d');
        const incomeTrendCanvas = document.getElementById('incomeTrendChart').getContext('2d');
        const expenseTrendCanvas = document.getElementById('expenseTrendChart').getContext('2d');
        const balanceTrendCanvas = document.getElementById('balanceTrendChart').getContext('2d');

        const expensePieGroupBySelect = document.getElementById('expensePieGroupBy');
        const incomeTrendGroupBySelect = document.getElementById('incomeTrendGroupBy');
        const expenseTrendGroupBySelect = document.getElementById('expenseTrendGroupBy');
        const netTrendGroupBySelect = document.getElementById('netTrendGroupBy');

        const expenseProjectFilterSelect = document.getElementById('expenseProjectFilter');
        const incomeProjectFilterSelect = document.getElementById('incomeProjectFilter');
        const expenseTrendProjectFilterSelect = document.getElementById('expenseTrendProjectFilter');

        const totalExpenseAmountElement = document.getElementById('totalExpenseAmount');
        const totalIncomeAmountElement = document.getElementById('totalIncomeAmount');
        const netIncomeAmountElement = document.getElementById('netIncomeAmount');

        // å¿«é€Ÿæ“ä½œæŒ‰é’®
        const quickIncomeBtn = document.getElementById('quickIncomeBtn');
        const quickExpenseBtn = document.getElementById('quickExpenseBtn');
        const quickFoodBtn = document.getElementById('quickFoodBtn');
        const addIncomeProjectBtn = document.getElementById('addIncomeProjectBtn');
        const addExpenseProjectBtn = document.getElementById('addExpenseProjectBtn');


        // --- æ•°æ®å­˜å‚¨/åŠ è½½ ---

        // ä¿å­˜æ•°æ®åˆ° localStorage
        function saveData() {
            localStorage.setItem('accountRecords', JSON.stringify(records));
            localStorage.setItem('accountProjects', JSON.stringify(projects));
        }

        // ä» localStorage åŠ è½½æ•°æ®
        function loadData() {
            const storedRecords = localStorage.getItem('accountRecords');
            const storedProjects = localStorage.getItem('accountProjects');

            if (storedRecords) {
                records = JSON.parse(storedRecords).map(record => ({
                    ...record,
                    // ç¡®ä¿ amount æ˜¯æ•°å­—
                    amount: parseFloat(record.amount)
                }));
            }
            if (storedProjects) {
                projects = JSON.parse(storedProjects);
                // ç¡®ä¿åˆå§‹é¡¹ç›®åˆ—è¡¨åŒ…å«æ‰€æœ‰é»˜è®¤é¡¹ç›®ï¼Œå¹¶å¤„ç†æ–°æ·»åŠ çš„é¡¹ç›®
                const defaultProjects = [
                    { id: 1, name: "å·¥èµ„", type: "income", emoji: "ğŸ’°" },
                    { id: 2, name: "ç†è´¢æ”¶å…¥", type: "income", emoji: "ğŸ“ˆ" },
                    { id: 3, name: "å…¶ä»–æ”¶å…¥", type: "income", emoji: "ğŸ" },
                    { id: 4, name: "åƒé¥­", type: "expense", emoji: "ğŸ”" },
                    { id: 5, name: "äº¤é€š", type: "expense", emoji: "ğŸš—" },
                    { id: 6, name: "ä½æˆ¿", type: "expense", emoji: "ğŸ " },
                    { id: 7, name: "è´­ç‰©", type: "expense", emoji: "ğŸ›ï¸" },
                    { id: 8, name: "å¨±ä¹", type: "expense", emoji: "ğŸ¬" },
                    { id: 9, name: "åŒ»ç–—", type: "expense", emoji: "âš•ï¸" },
                    { id: 10, name: "å­¦ä¹ ", type: "expense", emoji: "ğŸ“š" },
                    { id: 11, name: "æŠ•èµ„æ”¯å‡º", type: "expense", emoji: "ğŸ“‰" },
                    { id: 12, name: "æ—¥ç”¨å“", type: "expense", emoji: "ğŸ§´" },
                    { id: 13, name: "å® ç‰©", type: "expense", emoji: "ğŸ¶" },
                    { id: 14, name: "ç”µå­äº§å“", type: "expense", emoji: "ğŸ“±" },
                    { id: 15, name: "æ—…æ¸¸", type: "expense", emoji: "âœˆï¸" },
                    { id: 16, name: "äººæƒ…å¾€æ¥", type: "expense", emoji: "ğŸ§§" },
                    { id: 17, name: "é€šè®¯", type: "expense", emoji: "ğŸ“" },
                    { id: 18, name: "æ°´ç”µç…¤", type: "expense", emoji: "ğŸ’¡" },
                    { id: 19, name: "è¿åŠ¨å¥èº«", type: "expense", emoji: "ğŸƒ" },
                    { id: 20, name: "æœé¥°", type: "expense", emoji: "ğŸ‘—" },
                    { id: 21, name: "ç¤¼ç‰©", type: "expense", emoji: "ğŸ" },
                    { id: 22, name: "é¥°å“", type: "expense", emoji: "ğŸ’" },
                    { id: 23, name: "è®¾å¤‡", type: "expense", emoji: "ğŸ’»" }
                ];

                // ç®€å•çš„åˆå¹¶é€»è¾‘ï¼šä¿ç•™ç”¨æˆ·æ·»åŠ çš„é¡¹ç›®ï¼Œç”¨å­˜å‚¨çš„é¡¹ç›®è¦†ç›–é»˜è®¤é¡¹ç›®
                const storedProjectMap = new Map(projects.map(p => [p.id, p]));
                projects = defaultProjects.map(p => storedProjectMap.get(p.id) || p);
                
                // æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰é¡¹ç›®ï¼ˆid > 23ï¼‰
                storedProjectMap.forEach(p => {
                    if (p.id > 23) {
                        projects.push(p);
                    }
                });
                
                // ç¡®ä¿è®°å½•ä¸­çš„é¡¹ç›®ä¿¡æ¯æ˜¯æœ€æ–°çš„ï¼ˆé˜²æ­¢é¡¹ç›®åç§°/emojiä¿®æ”¹åè®°å½•æœªåŒæ­¥ï¼‰
                records = records.map(record => {
                    const project = projects.find(p => p.id === record.projectId);
                    return {
                        ...record,
                        projectName: project ? project.name : record.projectName,
                        projectEmoji: project ? project.emoji : record.projectEmoji
                    };
                });
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        // æ›´æ–°æ€»é‡‘é¢
        function updateTotalAmount() {
            const total = records.reduce((sum, record) => sum + record.amount, 0);
            totalAmountElement.textContent = `Â¥${total.toFixed(2)}`;
            totalAmountElement.style.color = total >= 0 ? '#2E8B57' : '#FF6B6B';
            totalAmountElement.className = 'amount ' + (total >= 0 ? 'income' : 'expense');
        }

        // æ›´æ–°è®°è´¦è¡¨å•çš„é¡¹ç›®é€‰æ‹©åˆ—è¡¨
        function updateProjectSelect() {
            const type = document.getElementById('type').value;
            const filteredProjects = projects.filter(p => p.type === type);
            projectSelect.innerHTML = '';
            
            // æ·»åŠ é€‰é¡¹
            filteredProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.name} ${project.emoji || ''}`;
                projectSelect.appendChild(option);
            });

            // å¦‚æœæ²¡æœ‰é¡¹ç›®ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤æç¤º
            if (filteredProjects.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = `è¯·å…ˆæ·»åŠ ${type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}é¡¹ç›®`;
                option.disabled = true;
                projectSelect.appendChild(option);
            }

            // å¦‚æœåƒé¥­é¡¹ç›®å­˜åœ¨ï¼Œä¸”å½“å‰ç±»å‹æ˜¯æ”¯å‡ºï¼Œåˆ™é»˜è®¤é€‰ä¸­åƒé¥­é¡¹ç›®
            const foodProject = projects.find(p => p.name === 'åƒé¥­' && p.type === 'expense');
            if (foodProject && type === 'expense') {
                document.getElementById('project').value = 4;
            }
        }

        // æ›´æ–°å¤šé€‰ä¸‹æ‹‰æ¡†é€‰é¡¹
        function updateMultiselectOptions() {
            multiselectOptions.innerHTML = '';
            projects.forEach(project => {
                const option = document.createElement('div');
                option.className = 'multiselect-option';
                option.dataset.id = project.id;
                option.innerHTML = `
                    <span class="emoji">${project.emoji || 'ğŸ“'}</span>
                    <span>${project.name}</span>
                    <span style="margin-left: auto; font-size: 0.8rem; color: #999;">${project.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span>
                `;
                option.addEventListener('click', () => toggleProjectSelection(project.id));
                
                // å¦‚æœé¡¹ç›®å·²è¢«é€‰ä¸­ï¼Œæ·»åŠ é€‰ä¸­æ ·å¼
                if (currentFilter.projects.includes(project.id)) {
                    option.classList.add('selected');
                }
                multiselectOptions.appendChild(option);
            });
            updateMultiselectSelected();
        }

        // åˆ‡æ¢é¡¹ç›®é€‰æ‹©çŠ¶æ€
        function toggleProjectSelection(projectId) {
            const index = currentFilter.projects.indexOf(projectId);
            if (index === -1) {
                // æ·»åŠ é¡¹ç›®
                currentFilter.projects.push(projectId);
            } else {
                // ç§»é™¤é¡¹ç›®
                currentFilter.projects.splice(index, 1);
            }
            // æ›´æ–°UI
            updateMultiselectOptions();
        }

        // æ›´æ–°å·²é€‰é¡¹ç›®æ˜¾ç¤º
        function updateMultiselectSelected() {
            multiselectSelected.innerHTML = '';
            if (currentFilter.projects.length === 0) {
                multiselectInput.textContent = 'é€‰æ‹©é¡¹ç›®...';
                return;
            }

            multiselectInput.textContent = `å·²é€‰æ‹© ${currentFilter.projects.length} ä¸ªé¡¹ç›®`;

            currentFilter.projects.forEach(projectId => {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    const tag = document.createElement('div');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                        <span class="emoji">${project.emoji || 'ğŸ“'}</span>
                        <span>${project.name}</span>
                        <span class="remove" data-id="${project.id}">Ã—</span>
                    `;
                    tag.querySelector('.remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleProjectSelection(project.id);
                    });
                    multiselectSelected.appendChild(tag);
                }
            });
        }

        // åˆ‡æ¢å¤šé€‰ä¸‹æ‹‰æ¡†æ˜¾ç¤º
        function toggleMultiselectDropdown() {
            multiselectDropdown.classList.toggle('active');
            if (multiselectDropdown.classList.contains('active')) {
                // ç¡®ä¿æœç´¢æ¡†æ¸…ç©ºå¹¶èšç„¦
                multiselectSearch.value = '';
                filterMultiselectOptions();
                setTimeout(() => multiselectSearch.focus(), 50);
            }
        }

        // ç­›é€‰å¤šé€‰é€‰é¡¹
        function filterMultiselectOptions() {
            const filterText = multiselectSearch.value.toLowerCase();
            document.querySelectorAll('.multiselect-option').forEach(option => {
                const optionText = option.querySelector('span:nth-child(2)').textContent.toLowerCase();
                if (optionText.includes(filterText)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // æ¸²æŸ“è®°å½•è¡¨æ ¼
        function updateRecordsTable() {
            // ç­›é€‰è®°å½•
            let filteredRecords = applyFilterToRecords(records);
            
            // è®¡ç®—æ€»é¡µæ•°
            const totalRecords = filteredRecords.length;
            totalPages = Math.ceil(totalRecords / pageSize);
            
            // ç¡®ä¿å½“å‰é¡µç æœ‰æ•ˆ
            if (currentPage > totalPages) currentPage = totalPages || 1;
            if (currentPage < 1) currentPage = 1;

            // åˆ†é¡µé€»è¾‘
            const start = (currentPage - 1) * pageSize;
            const end = currentPage * pageSize;
            const pagedRecords = filteredRecords.slice(start, end);

            // æ¸…ç©ºè¡¨æ ¼
            recordsTable.innerHTML = '';

            // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (pagedRecords.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('paginationSection').style.display = 'none';
                updateSearchResultsInfo(filteredRecords.length);
                return;
            } else {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('paginationSection').style.display = 'flex';
            }

            // å¡«å……è®°å½•
            pagedRecords.forEach(record => {
                const row = recordsTable.insertRow();
                row.dataset.id = record.id;
                
                // æ—¥æœŸ
                row.insertCell(0).textContent = record.date;
                
                // ç±»å‹
                const typeCell = row.insertCell(1);
                typeCell.innerHTML = `
                    <span class="type-indicator ${record.type === 'income' ? 'type-income' : 'type-expense'}"></span>
                    ${record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}
                `;
                
                // é¡¹ç›®
                const projectCell = row.insertCell(2);
                projectCell.innerHTML = `<span class="emoji">${record.projectEmoji || 'ğŸ“'}</span> ${record.projectName}`;
                
                // é‡‘é¢
                const amountCell = row.insertCell(3);
                amountCell.textContent = `Â¥${Math.abs(record.amount).toFixed(2)}`;
                amountCell.className = record.type === 'income' ? 'income' : 'expense';
                
                // å¤‡æ³¨
                const noteCell = row.insertCell(4);
                noteCell.textContent = record.note || '-';
                noteCell.title = record.note || '';
                
                // æ“ä½œ
                const actionCell = row.insertCell(5);
                actionCell.className = 'actions';
                actionCell.innerHTML = `
                    <button class="btn btn-danger delete-record" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                `;
            });

            // æ·»åŠ åˆ é™¤è®°å½•çš„äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.delete-record').forEach(button => {
                button.addEventListener('click', function() {
                    const recordId = parseInt(this.getAttribute('data-id'));
                    deleteRecord(recordId);
                });
            });

            // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
            updateSearchResultsInfo(filteredRecords.length);
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePaginationInfo();
        }

        // åº”ç”¨ç­›é€‰æ¡ä»¶åˆ°è®°å½•
        function applyFilterToRecords(records) {
            let filtered = [...records];

            // æ—¥æœŸç­›é€‰
            if (currentFilter.startDate) {
                filtered = filtered.filter(record => record.date >= currentFilter.startDate);
            }
            if (currentFilter.endDate) {
                filtered = filtered.filter(record => record.date <= currentFilter.endDate);
            }

            // é¡¹ç›®ç­›é€‰
            if (currentFilter.projects.length > 0) {
                filtered = filtered.filter(record => currentFilter.projects.includes(record.projectId));
            }

            return filtered;
        }

        // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
        function updateSearchResultsInfo(count) {
            let infoText = `æ˜¾ç¤º <span class="record-count">${count}</span> æ¡è®°å½•`;
            if (currentFilter.startDate || currentFilter.endDate || currentFilter.projects.length > 0) {
                infoText += "ï¼ˆå·²åº”ç”¨ç­›é€‰æ¡ä»¶ï¼‰";
            } else {
                infoText += "ï¼ˆå…¨éƒ¨è®°å½•ï¼‰";
            }
            searchResultsInfo.innerHTML = infoText;
        }

        // æ·»åŠ æ–°è®°å½•
        function addRecord(e) {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;
            const projectId = parseInt(document.getElementById('project').value);
            let amount = parseFloat(document.getElementById('amount').value);
            const note = document.getElementById('note').value;

            // éªŒè¯é‡‘é¢
            if (isNaN(amount) || amount <= 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', 'danger');
                document.getElementById('amount').focus();
                return;
            }
            
            // éªŒè¯é¡¹ç›®
            if (!projectId) {
                showNotification('è¯·é€‰æ‹©é¡¹ç›®', 'danger');
                return;
            }

            // å¦‚æœæ˜¯æ”¯å‡ºï¼Œé‡‘é¢è½¬ä¸ºè´Ÿæ•°
            if (type === 'expense') {
                amount = -Math.abs(amount);
            }

            // è·å–é¡¹ç›®åç§°å’Œemoji
            const project = projects.find(p => p.id === projectId);
            const projectName = project ? project.name : 'æœªçŸ¥';
            const projectEmoji = project ? project.emoji : 'ğŸ“';

            // åˆ›å»ºæ–°è®°å½•
            const newRecord = {
                id: Date.now(),
                date,
                type,
                projectId,
                projectName,
                projectEmoji,
                amount,
                note
            };

            records.unshift(newRecord); // æ·»åŠ åˆ°å¼€å¤´ï¼Œè¿™æ ·æœ€æ–°çš„è®°å½•æ˜¾ç¤ºåœ¨æœ€å‰é¢
            saveData();
            
            // é‡ç½®åˆ†é¡µå’Œç­›é€‰
            currentPage = 1; 
            currentFilter = { startDate: null, endDate: null, projects: [] };
            resetFilterUI();

            updateRecordsTable();
            updateTotalAmount();
            resetForm();

            // æ›´æ–°åˆ†æå›¾è¡¨ï¼ˆå¦‚æœå½“å‰åœ¨åˆ†æé¡µé¢ï¼‰
            if (currentMobileTab === 'analysis' || window.innerWidth > 767) {
                 updateAnalysisCharts();
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification(`æˆåŠŸæ·»åŠ ${type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}è®°å½•ï¼`, 'success');

            // åœ¨ç§»åŠ¨ç«¯åˆ‡æ¢åˆ°è®°å½•æ ‡ç­¾
            if (window.innerWidth <= 767) {
                setTimeout(() => switchMobileTab('records'), 500);
            }
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(recordId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                records = records.filter(record => record.id !== recordId);
                saveData();
                updateRecordsTable();
                updateTotalAmount();
                updateAnalysisCharts();
                showNotification('è®°å½•å·²åˆ é™¤ï¼', 'success');
            }
        }

        // é‡ç½®è®°è´¦è¡¨å•
        function resetForm() {
            accountForm.reset();
            // æ¢å¤é»˜è®¤å€¼
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('type').value = 'expense';
            updateProjectSelect();
            document.getElementById('project').value = 4;
            document.getElementById('amount').value = '';
        }

        // æ¸…ç©ºæ‰€æœ‰è®°å½•
        function clearRecords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
                records = [];
                saveData();
                currentPage = 1;
                updateRecordsTable();
                updateTotalAmount();
                updateAnalysisCharts();
                showNotification('æ‰€æœ‰è®°å½•å·²æ¸…ç©ºï¼', 'danger');
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            // å‡†å¤‡å¯¼å‡ºæ•°æ®
            const data = records.map(record => ({
                'æ—¥æœŸ': record.date,
                'ç±»å‹': record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                'é¡¹ç›®': record.projectName,
                'é‡‘é¢': Math.abs(record.amount).toFixed(2),
                'å¤‡æ³¨': record.note || ''
            }));

            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è®°è´¦è®°å½•");

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, `è®°è´¦è®°å½•_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`);
            showNotification('è®°å½•å¯¼å‡ºæˆåŠŸï¼', 'success');
        }

        // --- é¡¹ç›®ç®¡ç†å‡½æ•° ---

        // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
        function updateProjectList() {
            projectList.innerHTML = '';
            projects.sort((a, b) => {
                if (a.type === b.type) {
                    return a.id - b.id; // åŒç±»å‹æŒ‰IDæ’åº
                }
                return a.type === 'expense' ? -1 : 1; // æ”¯å‡ºæ’åœ¨å‰é¢
            }).forEach(project => {
                const item = document.createElement('div');
                item.className = `project-item ${project.type}`;
                item.innerHTML = `
                    <span class="emoji">${project.emoji || 'ğŸ“'}</span>
                    <span>${project.name}</span>
                    <span style="margin-left: auto; font-size: 0.85rem; color: #999;">${project.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span>
                    <div class="actions">
                        <button class="btn btn-secondary edit-project" data-id="${project.id}" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger delete-project" data-id="${project.id}" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                projectList.appendChild(item);
            });

            // æ·»åŠ ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.edit-project').forEach(button => {
                button.addEventListener('click', function() {
                    const projectId = parseInt(this.getAttribute('data-id'));
                    editProject(projectId);
                });
            });

            document.querySelectorAll('.delete-project').forEach(button => {
                button.addEventListener('click', function() {
                    const projectId = parseInt(this.getAttribute('data-id'));
                    deleteProject(projectId);
                });
            });
        }

        // æ‰“å¼€é¡¹ç›®æ¨¡æ€æ¡†
        function openProjectModal(isEdit = false, defaultType = 'expense') {
            projectModal.style.display = 'flex';
            document.getElementById('projectName').value = '';
            document.getElementById('projectType').value = defaultType;
            editingProjectId = null;
            document.querySelector('.modal-title').innerHTML = isEdit 
                ? '<i class="fas fa-edit"></i> ç¼–è¾‘é¡¹ç›®' 
                : '<i class="fas fa-edit"></i> æ·»åŠ é¡¹ç›®';
        }

        // ç¼–è¾‘é¡¹ç›®
        function editProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                openProjectModal(true);
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectType').value = project.type;
                editingProjectId = projectId;
            }
        }

        // å…³é—­é¡¹ç›®æ¨¡æ€æ¡†
        function closeProjectModal() {
            projectModal.style.display = 'none';
        }

        // ä¿å­˜é¡¹ç›®
        function saveProject(e) {
            e.preventDefault();
            const name = document.getElementById('projectName').value.trim();
            const type = document.getElementById('projectType').value;

            if (!name) {
                showNotification('è¯·è¾“å…¥é¡¹ç›®åç§°', 'danger');
                return;
            }

            // æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„é¡¹ç›®ï¼‰
            const existingProject = projects.find(p => 
                p.name.toLowerCase() === name.toLowerCase() && p.id !== editingProjectId
            );

            if (existingProject) {
                showNotification('é¡¹ç›®åç§°å·²å­˜åœ¨', 'danger');
                return;
            }

            if (editingProjectId) {
                // æ›´æ–°ç°æœ‰é¡¹ç›®
                const projectIndex = projects.findIndex(p => p.id === editingProjectId);
                if (projectIndex !== -1) {
                    projects[projectIndex].name = name;
                    projects[projectIndex].type = type;
                }
                showNotification('é¡¹ç›®å·²æ›´æ–°ï¼', 'success');
            } else {
                // æ·»åŠ æ–°é¡¹ç›®
                const newId = projects.length > 0 ? Math.max(...projects.map(p => p.id)) + 1 : 1;
                projects.push({ 
                    id: newId, 
                    name, 
                    type, 
                    emoji: type === 'income' ? 'ğŸ’°' : 'ğŸ’¸' 
                });
                showNotification('é¡¹ç›®å·²æ·»åŠ ï¼', 'success');
            }
            
            saveData();
            updateProjectSelect();
            updateProjectList();
            updateMultiselectOptions();
            updateAnalysisProjectSelects(); // æ›´æ–°åˆ†æé¡µé¢çš„é¡¹ç›®ç­›é€‰
            closeProjectModal();
        }

        // åˆ é™¤é¡¹ç›®
        function deleteProject(projectId) {
            // æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•ä½¿ç”¨æ­¤é¡¹ç›®
            const recordsUsingProject = records.filter(record => record.projectId === projectId);
            if (recordsUsingProject.length > 0) {
                showNotification('æ— æ³•åˆ é™¤è¯¥é¡¹ç›®ï¼Œå› ä¸ºæœ‰è®°å½•æ­£åœ¨ä½¿ç”¨å®ƒã€‚è¯·å…ˆåˆ é™¤ç›¸å…³è®°å½•ã€‚', 'danger');
                return;
            }

            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) {
                projects = projects.filter(project => project.id !== projectId);
                saveData();
                updateProjectSelect();
                updateProjectList();
                updateMultiselectOptions();
                updateAnalysisProjectSelects();
                showNotification('é¡¹ç›®å·²åˆ é™¤ï¼', 'success');
            }
        }


        // --- è®°å½•ç­›é€‰/åˆ†é¡µå‡½æ•° ---

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        function applyFilter() {
            currentFilter.startDate = startDateInput.value;
            currentFilter.endDate = endDateInput.value;
            // currentFilter.projects å·²ç»åœ¨ toggleProjectSelection ä¸­æ›´æ–°

            currentPage = 1; // é‡æ–°ç­›é€‰åå›åˆ°ç¬¬ä¸€é¡µ
            updateRecordsTable();
            showNotification('ç­›é€‰æ¡ä»¶å·²åº”ç”¨', 'success');
        }

        // é‡ç½®ç­›é€‰æ¡ä»¶
        function resetFilter() {
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            endDateInput.value = today;
            
            currentFilter = { 
                startDate: startDateInput.value, 
                endDate: endDateInput.value, 
                projects: [] 
            };
            
            resetFilterUI();
            
            currentPage = 1;
            updateRecordsTable();
            showNotification('ç­›é€‰æ¡ä»¶å·²é‡ç½®', 'success');
        }
        
        // é‡ç½®ç­›é€‰ UI (æ—¥æœŸ/å¤šé€‰æ¡†)
        function resetFilterUI() {
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            endDateInput.value = today;
            
            updateMultiselectOptions();
            multiselectDropdown.classList.remove('active');
        }


        // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
        function changePageSize() {
            pageSize = parseInt(pageSizeSelect.value);
            currentPage = 1;
            updateRecordsTable();
        }

        // åˆ‡æ¢é¡µç 
        function changePage(page) {
            currentPage = page;
            updateRecordsTable();
        }

        // ä¸Šä¸€é¡µ
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateRecordsTable();
            }
        }

        // ä¸‹ä¸€é¡µ
        function goToNextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                updateRecordsTable();
            }
        }

        // æœ«é¡µ
        function goToLastPage() {
            currentPage = totalPages;
            updateRecordsTable();
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePaginationInfo() {
            const filteredRecords = applyFilterToRecords(records);
            const totalRecords = filteredRecords.length;
            
            const startRecord = (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(currentPage * pageSize, totalRecords);

            paginationInfo.innerHTML = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µï¼Œæ¯é¡µ ${pageSize} æ¡è®°å½•`;
            currentPageIndicator.textContent = currentPage;

            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;

            // éšè—/æ˜¾ç¤ºåˆ†é¡µæ¡
            if (totalPages <= 1) {
                document.getElementById('paginationSection').style.display = 'none';
            } else {
                document.getElementById('paginationSection').style.display = 'flex';
            }
        }


        // --- å¯¼å…¥ç›¸å…³å‡½æ•° ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                importFileLabel.innerHTML = `<i class="fas fa-upload"></i> é€‰æ‹©Excel/CSVæ–‡ä»¶å¯¼å…¥`;
                importBtn.disabled = true;
                importPreview.style.display = 'none';
                importData = [];
                return;
            }

            importFileLabel.innerHTML = `<i class="fas fa-file-excel"></i> å·²é€‰æ‹©: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (jsonData.length < 2 || jsonData[0].join(',') !== 'æ—¥æœŸ,ç±»å‹,é¡¹ç›®,é‡‘é¢,å¤‡æ³¨') {
                        showNotification('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ä¸‹è½½çš„æ¨¡æ¿æ–‡ä»¶ï¼', 'danger');
                        importBtn.disabled = true;
                        importPreview.style.display = 'none';
                        importData = [];
                        return;
                    }
                    
                    // æå–å’ŒéªŒè¯æ•°æ®
                    const validRecords = [];
                    const header = jsonData[0];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length < 4 || !row[0] || !row[1] || !row[2] || !row[3]) continue; // è·³è¿‡æ— æ•ˆè¡Œ

                        const date = row[0].toString().split(' ')[0]; // å…¼å®¹ Excel æ—¥æœŸæ ¼å¼ (å–ç¬¬ä¸€ä¸ªç©ºæ ¼ä¹‹å‰)
                        const type = row[1].toLowerCase().includes('æ”¶å…¥') || row[1].toLowerCase().includes('income') ? 'income' : 
                                     (row[1].toLowerCase().includes('æ”¯å‡º') || row[1].toLowerCase().includes('expense') ? 'expense' : null);
                        const projectName = row[2].toString().trim();
                        let amount = parseFloat(row[3]);
                        const note = row[4] ? row[4].toString().trim() : '';
                        
                        // é¢å¤–çš„æ•°æ®éªŒè¯
                        if (!type || isNaN(amount) || amount <= 0 || !projectName) continue;

                        // æŸ¥æ‰¾é¡¹ç›®IDï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è‡ªåŠ¨æ·»åŠ 
                        let project = projects.find(p => p.name === projectName && p.type === type);
                        if (!project) {
                            const newId = projects.length > 0 ? Math.max(...projects.map(p => p.id)) + 1 : 1;
                            project = { 
                                id: newId, 
                                name: projectName, 
                                type: type, 
                                emoji: type === 'income' ? 'ğŸ’°' : 'ğŸ’¸' 
                            };
                            projects.push(project);
                        }

                        // æ ¼å¼åŒ–é‡‘é¢å’Œç±»å‹
                        if (type === 'expense') {
                            amount = -Math.abs(amount);
                        }

                        validRecords.push({
                            id: Date.now() + i, // ä½¿ç”¨ä¸åŒçš„ID
                            date,
                            type,
                            projectId: project.id,
                            projectName: project.name,
                            projectEmoji: project.emoji,
                            amount,
                            note
                        });
                    }

                    if (validRecords.length > 0) {
                        importData = validRecords;
                        showImportPreview();
                        importWarning.textContent = `å°†å¯¼å…¥ ${validRecords.length} æ¡æœ‰æ•ˆè®°å½•ã€‚è¯·ç¡®ä¿æ—¥æœŸå’Œé‡‘é¢æ­£ç¡®ã€‚`;
                        importBtn.disabled = false;
                        importPreview.style.display = 'block';
                    } else {
                        showNotification('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è®°å½•æ•°æ®', 'danger');
                        importBtn.disabled = true;
                        importPreview.style.display = 'none';
                        importData = [];
                    }

                } catch (error) {
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                    showNotification('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'danger');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showImportPreview() {
            importPreviewBody.innerHTML = '';
            // åªæ˜¾ç¤ºå‰5æ¡è®°å½•ä½œä¸ºé¢„è§ˆ
            const previewData = importData.slice(0, 5);

            previewData.forEach(record => {
                const row = importPreviewBody.insertRow();
                // æ—¥æœŸ
                row.insertCell(0).textContent = record.date;
                // ç±»å‹
                row.insertCell(1).textContent = record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
                // é¡¹ç›®
                row.insertCell(2).textContent = record.projectName;
                // é‡‘é¢
                row.insertCell(3).textContent = `Â¥${Math.abs(record.amount).toFixed(2)}`;
                // å¤‡æ³¨
                row.insertCell(4).textContent = record.note || '-';
            });

            if (importData.length > 5) {
                const row = importPreviewBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.style.textAlign = 'center';
                cell.textContent = `... è¿˜æœ‰ ${importData.length - 5} æ¡è®°å½•æœªæ˜¾ç¤º ...`;
            }
        }

        function importRecords() {
            if (importData.length === 0) {
                showNotification('æ²¡æœ‰å¯å¯¼å…¥çš„è®°å½•', 'danger');
                return;
            }

            records.unshift(...importData); // å¯¼å…¥åˆ°è®°å½•åˆ—è¡¨çš„å¼€å¤´

            // ä¿å­˜æ•°æ®ï¼Œæ›´æ–°åˆ—è¡¨
            saveData();
            currentPage = 1;
            updateRecordsTable();
            updateTotalAmount();
            updateProjectSelect();
            updateMultiselectOptions();
            updateAnalysisProjectSelects();
            updateAnalysisCharts();

            // é‡ç½®å¯¼å…¥çŠ¶æ€
            importFileInput.value = '';
            importFileLabel.innerHTML = `<i class="fas fa-upload"></i> é€‰æ‹©Excel/CSVæ–‡ä»¶å¯¼å…¥`;
            importBtn.disabled = true;
            importPreview.style.display = 'none';
            importData = [];
            
            showNotification(`æˆåŠŸå¯¼å…¥ ${records.length} æ¡è®°å½•ï¼`, 'success');
        }

        function downloadTemplate() {
            // åˆ›å»ºæ¨¡æ¿æ•°æ®
            const templateData = [
                ['æ—¥æœŸ', 'ç±»å‹', 'é¡¹ç›®', 'é‡‘é¢', 'å¤‡æ³¨'],
                ['2023-01-01', 'æ”¶å…¥', 'å·¥èµ„', '5000', 'ä¸€æœˆå·¥èµ„'],
                ['2023-01-02', 'æ”¯å‡º', 'åƒé¥­', '50', 'åˆé¤'],
                ['2023-01-03', 'æ”¯å‡º', 'è´­ç‰©', '200', 'æ–°è¡£æœ'],
                ['2023-01-04', 'æ”¶å…¥', 'å…¶ä»–æ”¶å…¥', '100', 'çº¢åŒ…'],
                ['2023-01-05', 'æ”¯å‡º', 'æ—¥ç”¨å“', '80', 'æ´—å‘æ°´']
            ];
            
            // åˆ›å»ºå·¥ä½œç°¿
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è´¦æœ¬è®°å½•æ¨¡æ¿");
            
            // è®¾ç½®åˆ—å®½
            const colWidths = [
                { wch: 12 }, // æ—¥æœŸ
                { wch: 8 },  // ç±»å‹
                { wch: 12 }, // é¡¹ç›®
                { wch: 10 }, // é‡‘é¢
                { wch: 25 }  // å¤‡æ³¨
            ];
            ws['!cols'] = colWidths;
            
            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(wb, "è®°è´¦æœ¬å¯¼å…¥æ¨¡æ¿.xlsx");
        }


        // --- é€šçŸ¥/UX å‡½æ•° ---

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            // ç§»é™¤ç°æœ‰çš„é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.3s, transform 0.3s; min-width: 200px; text-align: center;">
                    ${message}
                </div>
            `;
            document.body.appendChild(notification);

            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                notification.querySelector('div').style.opacity = '1';
                notification.querySelector('div').style.transform = 'translateX(-50%) translateY(0)';
            }, 10);

            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.querySelector('div').style.opacity = '0';
                notification.querySelector('div').style.transform = 'translateX(-50%) translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // å¿«é€Ÿæ·»åŠ è®°å½•
        function quickAddRecord(type, defaultProject, defaultAmount) {
            // è®¾ç½®è¡¨å•å€¼
            document.getElementById('type').value = type;
            updateProjectSelect(); // é‡æ–°æ¸²æŸ“é¡¹ç›®åˆ—è¡¨ä»¥åŒ¹é…ç±»å‹
            document.getElementById('project').value = defaultProject;
            document.getElementById('amount').value = defaultAmount || '';
            document.getElementById('note').value = '';

            showNotification('è¯·å¡«å†™é‡‘é¢å¹¶ç‚¹å‡» "æ·»åŠ è®°å½•"', 'success');
            document.getElementById('amount').focus();

            // ç§»åŠ¨ç«¯ï¼šåˆ‡æ¢åˆ°è®°è´¦æ ‡ç­¾
            if (window.innerWidth <= 767) {
                switchMobileTab('form');
            }
        }

        // æ»šåŠ¨åˆ°è®°è´¦è¡¨å•
        function scrollToForm() {
            const formSection = document.getElementById('formTab');
            formSection.scrollIntoView({ behavior: 'smooth' });
            // ç§»åŠ¨ç«¯ï¼šåˆ‡æ¢åˆ°è®°è´¦æ ‡ç­¾
            if (window.innerWidth <= 767) {
                switchMobileTab('form');
            }
        }


        // --- ç§»åŠ¨ç«¯ Tab åˆ‡æ¢ ---

        // åˆ‡æ¢ç§»åŠ¨ç«¯æ ‡ç­¾
        function switchMobileTab(tabId) {
            currentMobileTab = tabId;
            const sections = document.querySelectorAll('.content > div');
            const tabs = document.querySelectorAll('.mobile-tab');

            sections.forEach(section => {
                if (section.id === `${tabId}Tab`) {
                    section.classList.add('active');
                    section.style.display = 'block';
                    // å¦‚æœæ˜¯åˆ†æé¡µé¢ï¼Œç¡®ä¿å›¾è¡¨æ›´æ–°
                    if (tabId === 'analysis') {
                        updateAnalysisCharts();
                    }
                    // å¦‚æœæ˜¯é¡¹ç›®é¡µé¢ï¼Œç¡®ä¿åˆ—è¡¨æ›´æ–°
                    if (tabId === 'projects') {
                        updateProjectList();
                    }
                } else {
                    section.classList.remove('active');
                    section.style.display = 'none';
                }
            });

            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ ‡ç­¾äº‹ä»¶
        function initMobileTabEvents() {
            const tabs = document.querySelectorAll('.mobile-tab');
            tabs.forEach(tab => {
                // è§¦æ‘¸äº‹ä»¶ (ä¸ºäº†æ›´å¥½çš„ç§»åŠ¨ç«¯å“åº”)
                tab.addEventListener('touchstart', function() {
                    this.classList.add('touching');
                    isMobileTabTouchActive = true;
                }, { passive: true });

                tab.addEventListener('touchend', function() {
                    if (this.classList.contains('touching')) {
                        this.classList.remove('touching');
                        this.classList.add('clicked');
                        const tabId = this.getAttribute('data-tab');
                        switchMobileTab(tabId);
                        // å°éœ‡åŠ¨åé¦ˆ
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }
                    setTimeout(() => { this.classList.remove('clicked'); }, 200);
                }, { passive: true });

                // ç‚¹å‡»äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ä½¿ç”¨ï¼‰
                tab.addEventListener('click', function(e) {
                    // åœ¨ç§»åŠ¨ç«¯ï¼Œè§¦æ‘¸äº‹ä»¶å·²ç»å¤„ç†ï¼Œè¿™é‡Œåªå¤„ç†æ¡Œé¢ç«¯
                    if (window.innerWidth > 767) {
                        const tabId = this.getAttribute('data-tab');
                        switchMobileTab(tabId);
                    } else {
                        // åœ¨ç§»åŠ¨ç«¯ï¼Œé˜»æ­¢ç‚¹å‡»äº‹ä»¶çš„é»˜è®¤è¡Œä¸º
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            });
        }


        // --- å›¾è¡¨åˆ†æå‡½æ•° ---

        // è·å–é¢œè‰²
        function getColorForIndex(index) {
            const colors = [ 
                '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F', 
                '#7B68EE', '#FFA07A', '#20B2AA', '#FF8DC7', '#A3D8FF', '#FFD59E', 
                '#A8E6CF', '#FFAAA5', '#C1E3FF', '#83C5BE', '#FFC759', '#D90368'
            ];
            return colors[index % colors.length];
        }

        // æ›´æ–°åˆ†æé¡¹ç›®é€‰æ‹©åˆ—è¡¨
        function updateAnalysisProjectSelects() {
            const expenseProjects = projects.filter(p => p.type === 'expense');
            const incomeProjects = projects.filter(p => p.type === 'income');

            // è¾…åŠ©å‡½æ•°ï¼šå¡«å……é€‰æ‹©æ¡†
            const populateSelect = (selectElement, projects) => {
                selectElement.innerHTML = '';
                selectElement.innerHTML += `<option value="all">æ‰€æœ‰${projects[0]?.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}é¡¹ç›®</option>`;
                projects.forEach(p => {
                    selectElement.innerHTML += `<option value="${p.id}">${p.emoji} ${p.name}</option>`;
                });
            };

            populateSelect(expenseProjectFilterSelect, expenseProjects);
            populateSelect(incomeProjectFilterSelect, incomeProjects);
            populateSelect(expenseTrendProjectFilterSelect, expenseProjects);
        }

        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        function initAnalysisCharts() {
            // ç¡®ä¿å›¾è¡¨åªè¢«åˆå§‹åŒ–ä¸€æ¬¡
            if (!expensePieChart) {
                expensePieChart = new Chart(expensePieCanvas, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            title: { display: false }
                        }
                    }
                });

                incomeTrendChart = new Chart(incomeTrendCanvas, {
                    type: 'line',
                    data: { labels: [], datasets: [{ 
                        label: 'æ”¶å…¥è¶‹åŠ¿', 
                        data: [], 
                        borderColor: '#2E8B57', 
                        backgroundColor: 'rgba(46, 139, 87, 0.2)',
                        tension: 0.3,
                        fill: true
                    }] },
                    options: createTrendChartOptions('æ”¶å…¥è¶‹åŠ¿', '#2E8B57')
                });

                expenseTrendChart = new Chart(expenseTrendCanvas, {
                    type: 'line',
                    data: { labels: [], datasets: [{ 
                        label: 'æ”¯å‡ºè¶‹åŠ¿', 
                        data: [], 
                        borderColor: '#FF6B6B', 
                        backgroundColor: 'rgba(255, 107, 107, 0.2)',
                        tension: 0.3,
                        fill: true
                    }] },
                    options: createTrendChartOptions('æ”¯å‡ºè¶‹åŠ¿', '#FF6B6B')
                });

                balanceTrendChart = new Chart(balanceTrendCanvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ 
                        label: 'å‡€æ”¶å…¥', 
                        data: [], 
                        backgroundColor: []
                    }] },
                    options: createTrendChartOptions('å‡€æ”¶å…¥', '#118AB2')
                });
            }
            // ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ›´æ–°æ•°æ®
            updateAnalysisCharts();
        }

        function createTrendChartOptions(titleText, primaryColor) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: Â¥${Math.abs(context.parsed.y).toFixed(2)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'é‡‘é¢ (Â¥)' },
                        ticks: {
                            callback: (value) => `Â¥${Math.abs(value).toFixed(0)}`
                        }
                    },
                    x: {
                        title: { display: true, text: 'æ—¶é—´' }
                    }
                }
            };
        }

        // ä¸»æ›´æ–°å‡½æ•°
        function updateAnalysisCharts() {
            const filteredRecords = getFilteredAnalysisRecords();

            updateExpensePieChart(filteredRecords);
            updateIncomeTrendChart(filteredRecords);
            updateExpenseTrendChart(filteredRecords);
            updateBalanceTrendChart(filteredRecords);
        }
        
        // è·å–åˆ†ææ‰€éœ€çš„è¿‡æ»¤åçš„è®°å½•
        function getFilteredAnalysisRecords() {
            const startDate = analysisStartDateInput.value;
            const endDate = analysisEndDateInput.value;
            
            // è®¾ç½® analysisFilter
            analysisFilter.startDate = startDate;
            analysisFilter.endDate = endDate;
            
            let filtered = records.filter(record => {
                let pass = true;
                if (startDate && record.date < startDate) pass = false;
                if (endDate && record.date > endDate) pass = false;
                return pass;
            });

            return filtered;
        }


        // æ›´æ–°æ”¯å‡ºé¥¼å›¾
        function updateExpensePieChart(allFilteredRecords) {
            const expenseRecords = allFilteredRecords.filter(record => record.type === 'expense');
            const filterProjectId = parseInt(expenseProjectFilterSelect.value);
            
            let filteredExpenseRecords = expenseRecords;

            // è¿‡æ»¤ç‰¹å®šé¡¹ç›®
            if (filterProjectId && filterProjectId !== 'all') {
                filteredExpenseRecords = expenseRecords.filter(record => record.projectId === filterProjectId);
            }

            if (filteredExpenseRecords.length === 0) {
                document.getElementById('noExpenseData').style.display = 'block';
                document.getElementById('expenseSummary').style.display = 'none';
                expensePieChart.data.labels = [];
                expensePieChart.data.datasets[0].data = [];
                expensePieChart.update();
                return;
            }

            document.getElementById('noExpenseData').style.display = 'none';
            document.getElementById('expenseSummary').style.display = 'flex';
            
            const groupBy = expensePieGroupBySelect.value;
            let labels = [];
            let data = [];
            let colors = [];
            let totalExpense = 0;

            if (groupBy === 'project') {
                // æŒ‰é¡¹ç›®åˆ†ç»„
                const projectMap = {};
                filteredExpenseRecords.forEach(record => {
                    const projectName = record.projectName;
                    const amount = Math.abs(record.amount);
                    if (!projectMap[projectName]) {
                        projectMap[projectName] = 0;
                    }
                    projectMap[projectName] += amount;
                    totalExpense += amount;
                });

                // æŒ‰é‡‘é¢æ’åº
                const sortedProjects = Object.entries(projectMap)
                    .sort((a, b) => b[1] - a[1]);

                sortedProjects.forEach(([projectName, amount], index) => {
                    labels.push(projectName);
                    data.push(amount);
                    colors.push(getColorForIndex(index));
                });

            } else if (groupBy === 'type') {
                // æŒ‰ç±»å‹åˆ†ç»„ï¼ˆæ”¶å…¥/æ”¯å‡ºï¼‰ï¼Œä½†æ­¤å¤„ä»…ç­›é€‰äº†æ”¯å‡ºï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºæ¼”ç¤º/æ‰©å±•
                // ä»…è®¡ç®—æ€»æ”¯å‡º
                totalExpense = filteredExpenseRecords.reduce((sum, record) => sum + Math.abs(record.amount), 0);
                labels.push('æ€»æ”¯å‡º');
                data.push(totalExpense);
                colors.push(getColorForIndex(0));
            }
            
            totalExpenseAmountElement.textContent = `Â¥${totalExpense.toFixed(2)}`;

            expensePieChart.data.labels = labels;
            expensePieChart.data.datasets[0].data = data;
            expensePieChart.data.datasets[0].backgroundColor = colors;
            expensePieChart.update();
        }

        // é€šç”¨è¶‹åŠ¿æ•°æ®åˆ†ç»„å‡½æ•°
        function groupTrendData(records, type, groupBy) {
            const targetRecords = records.filter(record => record.type === type);
            const groupedData = {};
            let labels = [];
            let data = [];

            targetRecords.forEach(record => {
                const date = new Date(record.date);
                let key, label;

                if (groupBy === 'day') {
                    key = record.date;
                    label = record.date.slice(5); // MM-DD
                } else if (groupBy === 'week') {
                    // è·å–æœ¬å‘¨ä¸€æ—¥æœŸä½œä¸º key
                    const dayOfWeek = date.getDay(); // 0 (Sunday) to 6 (Saturday)
                    const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // è°ƒæ•´åˆ°å‘¨ä¸€
                    const weekStart = new Date(date.setDate(diff));
                    key = weekStart.toISOString().split('T')[0];
                    label = `${weekStart.getMonth() + 1}/${weekStart.getDate()}`;
                } else if (groupBy === 'month') {
                    key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    label = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
                }

                if (!groupedData[key]) {
                    groupedData[key] = { label: label, amount: 0 };
                }
                groupedData[key].amount += Math.abs(record.amount);
            });

            // æŒ‰æ—¶é—´æ’åº
            const sortedKeys = Object.keys(groupedData).sort();
            sortedKeys.forEach(key => {
                labels.push(groupedData[key].label);
                data.push(groupedData[key].amount);
            });

            return { labels, data };
        }

        // å°†æ•°æ®å¯¹é½åˆ°æ ‡ç­¾
        function alignDataToLabels(data, sourceLabels, targetLabels) {
            const result = [];
            targetLabels.forEach(label => {
                const index = sourceLabels.indexOf(label);
                if (index !== -1) {
                    result.push(data[index]);
                } else {
                    result.push(0);
                }
            });
            return result;
        }

        // æ›´æ–°æ”¶å…¥è¶‹åŠ¿å›¾
        function updateIncomeTrendChart(allFilteredRecords) {
            const groupBy = incomeTrendGroupBySelect.value;
            const filterProjectId = parseInt(incomeProjectFilterSelect.value);
            
            let filteredIncomeRecords = allFilteredRecords.filter(record => record.type === 'income');
            
            if (filterProjectId && filterProjectId !== 'all') {
                filteredIncomeRecords = filteredIncomeRecords.filter(record => record.projectId === filterProjectId);
            }

            if (filteredIncomeRecords.length === 0) {
                document.getElementById('noIncomeData').style.display = 'block';
                document.getElementById('incomeSummary').style.display = 'none';
                incomeTrendChart.data.labels = [];
                incomeTrendChart.data.datasets[0].data = [];
                incomeTrendChart.update();
                return;
            }

            document.getElementById('noIncomeData').style.display = 'none';
            document.getElementById('incomeSummary').style.display = 'flex';

            const { labels, data } = groupTrendData(filteredIncomeRecords, 'income', groupBy);

            const totalIncome = filteredIncomeRecords.reduce((sum, record) => sum + Math.abs(record.amount), 0);
            totalIncomeAmountElement.textContent = `Â¥${totalIncome.toFixed(2)}`;

            incomeTrendChart.data.labels = labels;
            incomeTrendChart.data.datasets[0].data = data;
            incomeTrendChart.update();
        }

        // æ›´æ–°æ”¯å‡ºè¶‹åŠ¿å›¾
        function updateExpenseTrendChart(allFilteredRecords) {
            const groupBy = expenseTrendGroupBySelect.value;
            const filterProjectId = parseInt(expenseTrendProjectFilterSelect.value);
            
            let filteredExpenseRecords = allFilteredRecords.filter(record => record.type === 'expense');

            if (filterProjectId && filterProjectId !== 'all') {
                filteredExpenseRecords = filteredExpenseRecords.filter(record => record.projectId === filterProjectId);
            }

            if (filteredExpenseRecords.length === 0) {
                document.getElementById('noExpenseTrendData').style.display = 'block';
                expenseTrendChart.data.labels = [];
                expenseTrendChart.data.datasets[0].data = [];
                expenseTrendChart.update();
                return;
            }

            document.getElementById('noExpenseTrendData').style.display = 'none';

            const { labels, data } = groupTrendData(filteredExpenseRecords, 'expense', groupBy);

            expenseTrendChart.data.labels = labels;
            expenseTrendChart.data.datasets[0].data = data;
            expenseTrendChart.update();
        }

        // æ›´æ–°å‡€æ”¶å…¥è¶‹åŠ¿å›¾
        function updateBalanceTrendChart(allFilteredRecords) {
            const groupBy = netTrendGroupBySelect.value;
            const { labels: incomeLabels, data: incomeData } = groupTrendData(allFilteredRecords, 'income', groupBy);
            const { labels: expenseLabels, data: expenseData } = groupTrendData(allFilteredRecords, 'expense', groupBy);

            // åˆå¹¶æ‰€æœ‰æ ‡ç­¾å¹¶æ’åº (ç¡®ä¿æ ‡ç­¾é¡ºåºä¸€è‡´)
            const allLabels = [...new Set([...incomeLabels, ...expenseLabels])].sort();

            if (allLabels.length === 0) {
                document.getElementById('noBalanceData').style.display = 'block';
                document.getElementById('netSummary').style.display = 'none';
                balanceTrendChart.data.labels = [];
                balanceTrendChart.data.datasets = [];
                balanceTrendChart.update();
                return;
            }

            document.getElementById('noBalanceData').style.display = 'none';
            document.getElementById('netSummary').style.display = 'flex';

            // å°†æ•°æ®å¯¹é½åˆ°åˆå¹¶åçš„æ ‡ç­¾
            const alignedIncomeData = alignDataToLabels(incomeData, incomeLabels, allLabels);
            const alignedExpenseData = alignDataToLabels(expenseData, expenseLabels, allLabels);

            // è®¡ç®—å‡€æ”¶å…¥
            const netData = alignedIncomeData.map((income, index) => income - alignedExpenseData[index]);

            const totalNet = netData.reduce((sum, amount) => sum + amount, 0);
            netIncomeAmountElement.textContent = `Â¥${totalNet.toFixed(2)}`;
            netIncomeAmountElement.className = 'chart-summary-value ' + (totalNet >= 0 ? 'income' : 'expense');

            // æ ¹æ®æ­£è´Ÿå€¼è®¾ç½®æŸ±çŠ¶å›¾é¢œè‰²
            const barColors = netData.map(amount => amount >= 0 ? '#2E8B57' : '#FF6B6B');

            balanceTrendChart.data.labels = allLabels;
            balanceTrendChart.data.datasets[0] = {
                label: 'å‡€æ”¶å…¥',
                data: netData,
                backgroundColor: barColors
            };
            balanceTrendChart.update();
        }

        // é‡ç½®åˆ†æç­›é€‰æ¡ä»¶
        function resetAnalysisFilter() {
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
            const today = new Date().toISOString().split('T')[0];
            analysisStartDateInput.value = ninetyDaysAgo.toISOString().split('T')[0];
            analysisEndDateInput.value = today;
            updateAnalysisCharts();
            showNotification('åˆ†ææ—¶é—´å·²é‡ç½®ä¸ºæœ€è¿‘90å¤©', 'success');
        }


        // --- åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š ---

        function init() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            // è®¾ç½®æŸ¥è¯¢æ—¥æœŸé»˜è®¤èŒƒå›´ï¼ˆæœ€è¿‘30å¤©ï¼‰
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            endDateInput.value = today;
            
            // åˆå§‹åŒ–ç­›é€‰æ¡ä»¶
            currentFilter.startDate = startDateInput.value;
            currentFilter.endDate = endDateInput.value;

            // è®¾ç½®åˆ†ææ—¥æœŸé»˜è®¤èŒƒå›´ï¼ˆæœ€è¿‘90å¤©ï¼‰
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
            analysisStartDateInput.value = ninetyDaysAgo.toISOString().split('T')[0];
            analysisEndDateInput.value = today;

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            loadData();
            
            // è®¾ç½®é»˜è®¤ç±»å‹ä¸ºæ”¯å‡º
            document.getElementById('type').value = 'expense'; 
            
            // æ›´æ–°é¡¹ç›®é€‰æ‹©åˆ—è¡¨
            updateProjectSelect();
            
            // è®¾ç½®é»˜è®¤é¡¹ç›®ä¸ºåƒé¥­ï¼ˆidä¸º4ï¼‰
            const foodProject = projects.find(p => p.name === 'åƒé¥­' && p.type === 'expense');
            if (foodProject) {
                document.getElementById('project').value = foodProject.id;
            }

            // æ›´æ–°é¡¹ç›®æ˜¾ç¤ºåˆ—è¡¨
            updateProjectList();
            
            // æ›´æ–°æŸ¥è¯¢é¡¹ç›®é€‰æ‹©åˆ—è¡¨
            updateMultiselectOptions();

            // æ›´æ–°è®°å½•è¡¨æ ¼
            updateRecordsTable();

            // æ›´æ–°æ€»é‡‘é¢
            updateTotalAmount();

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            updatePaginationInfo(); 
            
            // æ›´æ–°åˆ†æå›¾è¡¨é¡¹ç›®é€‰æ‹©
            updateAnalysisProjectSelects();

            // åˆå§‹åŒ–åˆ†æå›¾è¡¨
            initAnalysisCharts();
            
            // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ ‡ç­¾äº‹ä»¶
            initMobileTabEvents();
            
            // ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯è§†å›¾è°ƒæ•´
            if (window.innerWidth <= 767) {
                switchMobileTab('form'); // ç§»åŠ¨ç«¯é»˜è®¤æ˜¾ç¤ºè®°è´¦
            } else {
                // æ¡Œé¢ç«¯éšè—ç§»åŠ¨ç«¯æ ‡ç­¾
                document.querySelector('.mobile-tabs').style.display = 'none';
                // æ¡Œé¢ç«¯é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰section
                document.querySelectorAll('.content > div').forEach(section => {
                    section.style.display = 'block';
                    section.classList.add('active');
                });
            }

            // --- äº‹ä»¶ç›‘å¬å™¨ ---

            // è®°è´¦è¡¨å•
            accountForm.addEventListener('submit', addRecord);
            document.getElementById('type').addEventListener('change', updateProjectSelect);
            resetBtn.addEventListener('click', resetForm);

            // å¿«é€Ÿæ“ä½œæŒ‰é’®
            quickIncomeBtn.addEventListener('click', () => quickAddRecord('income', projects.find(p => p.type === 'income')?.id || 1, 100));
            quickExpenseBtn.addEventListener('click', () => quickAddRecord('expense', projects.find(p => p.name === 'è´­ç‰©')?.id || 7, 50));
            quickFoodBtn.addEventListener('click', () => quickAddRecord('expense', projects.find(p => p.name === 'åƒé¥­')?.id || 4, 20));

            // å¯¼å…¥/å¯¼å‡º
            exportBtn.addEventListener('click', exportData);
            clearBtn.addEventListener('click', clearRecords);
            importFileInput.addEventListener('change', handleFileSelect);
            downloadTemplateBtn.addEventListener('click', downloadTemplate);
            importBtn.addEventListener('click', importRecords);

            // ç­›é€‰/æŸ¥è¯¢
            searchBtn.addEventListener('click', applyFilter);
            resetSearchBtn.addEventListener('click', resetFilter);
            
            // åˆ†é¡µ
            pageSizeSelect.addEventListener('change', changePageSize);
            firstPageBtn.addEventListener('click', () => changePage(1));
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            lastPageBtn.addEventListener('click', goToLastPage);

            // å¤šé€‰ä¸‹æ‹‰æ¡†
            multiselectInput.addEventListener('click', toggleMultiselectDropdown);
            multiselectSearch.addEventListener('input', filterMultiselectOptions);
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', (e) => {
                if (!multiselectDropdown.contains(e.target) && e.target !== multiselectInput && multiselectDropdown.classList.contains('active')) {
                    multiselectDropdown.classList.remove('active');
                }
            });

            // é¡¹ç›®ç®¡ç†
            projectForm.addEventListener('submit', saveProject);
            addProjectBtn.addEventListener('click', () => openProjectModal(false, 'expense'));
            addIncomeProjectBtn.addEventListener('click', () => openProjectModal(false, 'income'));
            addExpenseProjectBtn.addEventListener('click', () => openProjectModal(false, 'expense'));
            cancelProjectBtn.addEventListener('click', closeProjectModal);
            closeModalBtn.addEventListener('click', closeProjectModal);

            // æµ®åŠ¨æŒ‰é’® (æ¡Œé¢ç«¯)
            quickAddBtn.addEventListener('click', scrollToForm);
            quickExportBtn.addEventListener('click', exportData);
            
            // åˆ†æå›¾è¡¨æ§åˆ¶
            updateAnalysisBtn.addEventListener('click', updateAnalysisCharts);
            resetAnalysisBtn.addEventListener('click', resetAnalysisFilter);
            expensePieGroupBySelect.addEventListener('change', () => updateExpensePieChart(getFilteredAnalysisRecords()));
            incomeTrendGroupBySelect.addEventListener('change', () => updateIncomeTrendChart(getFilteredAnalysisRecords()));
            expenseTrendGroupBySelect.addEventListener('change', () => updateExpenseTrendChart(getFilteredAnalysisRecords()));
            netTrendGroupBySelect.addEventListener('change', () => updateBalanceTrendChart(getFilteredAnalysisRecords()));
            expenseProjectFilterSelect.addEventListener('change', () => updateExpensePieChart(getFilteredAnalysisRecords()));
            incomeProjectFilterSelect.addEventListener('change', () => updateIncomeTrendChart(getFilteredAnalysisRecords()));
            expenseTrendProjectFilterSelect.addEventListener('change', () => updateExpenseTrendChart(getFilteredAnalysisRecords()));

        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œåˆå§‹åŒ–å‡½æ•°
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>